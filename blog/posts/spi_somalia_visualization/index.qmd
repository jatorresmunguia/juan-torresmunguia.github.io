---
title: "How to compute and visualize the standardized precipitation index (SPI) for drought analysis"
subtitle: "Part 2: Visualizing the SPI from Somalia at subnational level using {ggplot2} in R"
author: 
 - name: 
    given: Juan Armando 
    family: Torres Mungu√≠a
date: "2025-02-08"
categories: 
 - data visualization
 - drought
 - tidyverse
 - ggplot2
 - shapefiles
 - standardized precipitation index (SPI)
 - Somalia
image: "spi-somalia.png"
title-block-banner: false
citation: true
execute: 
  freeze: true
format: 
  html: 
    page-layout: article
comments:
  utterances: 
    repo: jatorresmunguia/juan-torresmunguia.github.io
---

## Overview
Previously, we calculated the Standardized Precipitation Index (SPI) for different time scales using the {SCI} package in R. In this tutorial, we will visualize the SPI values for Somalia at the subnational level using {ggplot2} and shapefiles.

## About the data
The information of the Somalian sub national administrative boundaries is obtained from the [Humanitarian Data Exchange (HDX) initiative](https://data.humdata.org/) of the United Nations Office for the Coordination of Humanitarian Affairs (OCHA). The information comes as a shapefile `.shp` and is available at https://data.humdata.org/dataset/cod-ab-som? in a zip file named `som_adm_ocha_20250108_AB_SHP.zip`. The shapefile contains the administrative boundaries of Somalia at the subnational level (regions). In particular, we will use file `som_admbnda_adm1_ocha_20250108.shp`, that contains the shapefile for the subnational regions of Somalia. I downloaded this file and located it in the `shp` folder.

## Set-up
Before we begin, we need to install and load the necessary R packages. We will be using the {tidyverse} package for data wrangling, as well as the {SCI} package for calculating the SPI.

```{r}
#| warning: false

library(tidyverse) # For data manipulation and visualization
library(sf) # For handling spatial data
library(ggplot2) # For data visualization

```

## Loading data HDX
Data can be found [here](https://data.humdata.org/dataset/som-rainfall-subnational) in file `som-rainfall-adm2-full.csv`. For Somalia, data is available from January 1981.

```{r}
#| warning: false

# Read the rainfall data for Somalia`
# You can also download the data from the HDX platform and read it locally
rainfall_data <- read.csv("https://data.humdata.org/dataset/ed6e1b4b-8094-47e6-bdf7-f6d56fa7abb9/resource/331ab214-0860-44ea-a53b-0a3fac601e82/download/som-rainfall-adm2-full.csv")

```

### Data wrangling
We preprocess the data to extract relevant information to calculate the SPI. We extract the year and month from the date column, calculate the rainfall anomaly, and group the data by year, month, and region_code. 

```{r}
#| warning: false

rainfall_data <- rainfall_data |>
  slice(-1) |> # Remove the first row (metadata)
  mutate(
    year = year(date), # Extract year from the 'date' column
    month = month(date), # Extract month from the 'date' column
    region_code = substr(ADM2_PCODE, 1, 4) # Extract first 4 characters from 'ADM2_PCODE' as 'region_code'
    ) |>
  rename(
    rainfall_monthly_total = rfh, # Rename the column 'rfh' to 'rainfall_monthly_total'
    rainfall_monthly_lt_average = rfh_avg # Rename the column 'rfh_avg' to 'rainfall_monthly_lt_average'
    ) |>
  mutate(
    rainfall_monthly_total = as.numeric(rainfall_monthly_total), # Convert rainfall total to numeric
    rainfall_monthly_lt_average = as.numeric(rainfall_monthly_lt_average) # Convert long-term average to numeric
  ) |>
  select(year, month, region_code, rainfall_monthly_total, rainfall_monthly_lt_average) # Select relevant columns

# Group by year, month, and region_code, and calculate mean rainfall values by region
rainfall_data <- rainfall_data |>
  group_by(year, month, region_code) |>
  summarise(
    rainfall_monthly_total = mean(rainfall_monthly_total, na.rm = TRUE), # Calculate the mean of rainfall total
    rainfall_monthly_lt_average = mean(rainfall_monthly_lt_average, na.rm = TRUE) # Calculate the mean of long-term average
  ) |>
  ungroup() |>
  # Optionally, you can calculate rainfall anomaly as a percentage of the long-term average
  # rainfall_anomaly = 1, indicates no anomaly 
  # < 1 indicates below average 
  # > 1 indicates above average
  mutate(
    rainfall_anomaly = rainfall_monthly_total / rainfall_monthly_lt_average 
  )

```

## We then calculate the SPI for different time scales (1, 3, 6, 12 months).
```{r}
#| warning: false


```

