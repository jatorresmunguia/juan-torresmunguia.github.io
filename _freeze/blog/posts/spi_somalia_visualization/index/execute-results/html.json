{
  "hash": "3f65fb5dddd9349f32ca68ae905dbed8",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"How to compute and visualize the Standardized Precipitation Index (SPI) for drought analysis\"\nsubtitle: \"Part 2: Visualizing the SPI for the districts of Somalia using {ggplot2} in R\"\nauthor: \n - name: \n    given: Juan Armando \n    family: Torres Munguía\ndate: \"2025-02-14\"\ncategories: \n - data visualization\n - drought\n - tidyverse\n - ggplot2\n - shapefiles\n - standardized precipitation index (SPI)\n - Somalia\nimage: \"spi-somalia-map.png\"\ntitle-block-banner: false\ncitation: true\nexecute: \n  freeze: true\nformat: \n  html: \n    page-layout: article\ncomments:\n  utterances: \n    repo: jatorresmunguia/juan-torresmunguia.github.io\n---\n\n\n## Overview\nPreviously, in [Part 1 of this tutorial](../spi_somalia/index.qmd), we calculated the Standardized Precipitation Index (SPI) for different time scales using the {SCI} package in R. Now, we will map the SPI values for the districts of Somalia using {sf} and {ggplot2} packages in R. \n\n## About the data\nThe information of the Somalian sub national administrative boundaries is obtained from the [Humanitarian Data Exchange (HDX) initiative](https://data.humdata.org/) of the United Nations Office for the Coordination of Humanitarian Affairs (OCHA). The information comes as a shapefile `.shp` and is available at https://data.humdata.org/dataset/cod-ab-som? in a zip file named `som_adm_ocha_20250108_AB_SHP.zip`. The shapefile contains the administrative boundaries of Somalia at the subnational level. In particular, we will use file `som_admbnda_ADM2_ocha_20250108.shp`, that contains the shapefile of Somalia at the district level. I downloaded this file and located it in `/shp` folder.\n\n## Set-up\nBefore we begin, we need to install and load the necessary R packages. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse) # For data manipulation and visualization\nlibrary(sf) # For handling spatial data\nlibrary(ggplot2) # For data visualization\nlibrary(patchwork) # For combining plots\nlibrary(ggtext) # Use rich text elements in ggplot\nlibrary(showtext) # Add custom fonts to plots\n```\n:::\n\n\n## Loading data HDX\nData can be found [here](https://data.humdata.org/dataset/som-rainfall-subnational) in file `som-rainfall-adm2-full.csv`. For Somalia, data is available from January 1981.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load the shapefile for Somalia\nshp_somalia <- read_sf(\"shp/som_admbnda_adm2_ocha_20250108.shp\")\n\n# Rename columns for better readability\nshp_somalia <- shp_somalia |>\n  rename(\n    district = ADM2_EN, # Rename ADM2_EN to district (English names of districts)\n    district_code = ADM2_PCODE # Rename ADM2_PCODE to district_code (district codes)\n  )\n```\n:::\n\n\n### Data wrangling\nI will add the SPI values previously calculated to the shapefile data frame. I saved the SPI values in a RData file named `rainfall_data.RData`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nload(\"rainfall_data.RData\")\n\n# First, we need to filter the SPI values for the last available month, i.e. December 2024\n# to have only one observation per district\nrainfall_data_dec2024 <- rainfall_data |>\n  filter(month == 2 & year == 2024)\n\n# Merge the shapefile with the SPI values\nshp_somalia <- shp_somalia |>\n  left_join(rainfall_data_dec2024, by = c(\"district_code\"))\n```\n:::\n\n\n## Set theme settings and define fonts, colors, and text to be used in the map\n\n::: {.cell}\n\n```{.r .cell-code}\n# Custom theme for the map and legend\ntheme_spi_map <- function() {\n  theme_minimal(\n    base_family = \"Roboto Condensed\" # Base theme with custom font\n  ) +\n    # Custom theme settings\n    theme(\n\n      # Title settings\n      plot.title.position = \"plot\", # Position of the title\n      plot.title = element_textbox(\n        color = \"black\",\n        face = \"bold\",\n        size = 22,\n        margin = margin(5, 0, 5, 0), # Top, right, bottom, left\n        width = unit(1, \"npc\") # Width of the title, npc == 1 corresponds to the full width of the plot\n      ),\n      plot.subtitle = element_textbox(\n        color = \"grey50\",\n        face = \"bold\",\n        size = 14,\n        margin = margin(20, 0, 10, 0),\n        width = unit(1, \"npc\")\n      ),\n\n      # Legend settings\n      legend.position = \"top\",\n      legend.title = element_blank(),\n      legend.key.height = unit(0.1, \"cm\"), # Height of the legend key\n      legend.key.width = unit(0.1, \"cm\"), # Width of the legend key\n      legend.spacing.x = unit(0.1, \"cm\"),\n      legend.key.spacing = unit(0.1, \"cm\"), # Spacing between legend keys\n      legend.text = element_text(\n        margin = margin(5, 0, 5, 0),\n        face = \"bold\",\n        color = \"grey10\",\n        size = 10\n      ),\n      legend.direction = \"horizontal\",\n      legend.byrow = FALSE,\n\n      # Caption settings\n      plot.caption = element_textbox(\n        color = \"grey70\",\n        face = \"italic\",\n        size = 10,\n        margin = margin(10, 0, 5, 0),\n        width = unit(1, \"npc\")\n      ),\n      plot.background = element_rect(\n        color = \"white\",\n        fill = \"white\"\n      ),\n      plot.margin = margin(20, 40, 20, 40)\n    )\n}\n\n# Title, subtitle, and caption for the waffle chart\ntitle_chart <- \"Standardized Precipitation Index (SPI) in Somalia\"\nsubtitle_chart <- \"February 2024\"\ncaption_chart <- \"Data: Somalia: Own estimations using Somalia Rainfall Indicators at Subnational Level (HDX) | Graphic: Juan Torres Munguía\"\n```\n:::\n\n\nNow, lets create a histogram of the SPI values for the districts of Somalia to use as a legend for the map.\n\n::: {.cell}\n\n```{.r .cell-code}\nspi_colors <- data.frame(\n  ymin = c(-5, -2, -1.5, -1, 0, 1, 1.5, 2),\n  ymax = c(-2, -1.5, -1, 0, 1, 1.5, 2, 5),\n  label = factor(\n    c(\n      \"Extreme dry\", \"Severe dry\", \"Moderate dry\", \"Near normal\",\n      \"Near normal\", \"Moderate wet\", \"Severe wet\", \"Extreme wet\"\n    ),\n    levels = c(\n      \"Extreme dry\", \"Severe dry\", \"Moderate dry\", \"Near normal\",\n      \"Moderate wet\", \"Severe wet\", \"Extreme wet\"\n    )\n  ),\n  fill = c(\n    \"#F76D5E\", \"#FFAD72\", \"#FFE099\", \"#E5FFE5\",\n    \"#E5FFE5\", \"#99EAFF\", \"#75D3FF\", \"#3D87FF\"\n  )\n)\n\nshp_somalia <- shp_somalia %>%\n  mutate(spi_category = cut(spi1,\n    breaks = c(-Inf, spi_colors$ymax),\n    labels = spi_colors$label,\n    right = TRUE\n  )) |> # right = TRUE means that the intervals are closed on the right\n  filter(!is.na(spi1))\n\nhistogram_spi <- shp_somalia |>\n  filter(!is.na(spi_category)) |>\n  ggplot(aes(x = spi_category, fill = spi_category)) +\n  geom_bar(color = \"white\") +\n  scale_fill_manual(values = setNames(spi_colors$fill, spi_colors$label)) +\n  labs(\n    title = \"\",\n    x = \"\",\n    y = \"Number of districts\"\n  ) +\n  theme_spi_map() +\n  theme(\n    legend.position = \"none\",\n    axis.title = element_text(\n      color = \"grey10\",\n      face = \"bold\",\n      size = 7\n    ),\n    axis.text = element_text(\n      color = \"grey10\",\n      face = \"bold\",\n      size = 7\n    ),\n    axis.line = element_blank(),\n    panel.grid = element_blank()\n  ) +\n  coord_flip()\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Read the shapefile of Somalia with the interior region borders\nshp_somalia_region <- read_sf(\"shp/som_admbnda_adm1_ocha_20250108.shp\")\n\nshp_somalia_region <- st_transform(shp_somalia_region, 3857) # Web Mercator projection\nshp_somalia <- st_transform(shp_somalia, 3857)\n\nmap_spi <- ggplot() +\n  geom_sf(\n    data = shp_somalia, aes(fill = spi_category), color = \"grey\", linewidth = 0.5\n  ) +\n  scale_fill_manual(values = setNames(spi_colors$fill, spi_colors$label)) +\n  geom_sf(data = shp_somalia_region, fill = NA, color = \"black\", linewidth = 0.9) +\n  labs(\n    title = title_chart,\n    subtitle = subtitle_chart,\n    caption = caption_chart,\n    x = \"\",\n    y = \"\",\n    fill = \"\"\n  ) +\n  theme_spi_map() +\n  theme(\n    legend.position = \"none\",\n    # Axis settings\n    axis.title = element_blank(),\n    axis.line = element_blank(),\n    axis.text = element_blank(),\n    axis.ticks = element_blank(),\n    panel.grid = element_blank()\n  )\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmap_spi +\n  inset_element(histogram_spi, left = 0.4, bottom = 0, right = 1, top = 0.4, on_top = FALSE)\n```\n\n```{.r .cell-code}\nshowtext_opts(dpi = 320) # Set the resolution of the image 320 dpi is for high-quality images (\"retina\")\nggsave(\n  \"spi-somalia-map.png\",\n  dpi = 320,\n  width = 12,\n  height = 9,\n  units = \"in\"\n)\nshowtext_auto(FALSE)\n```\n:::\n\n\n![](spi-somalia-map.png){width=100% style=\"margin-top: 0px; margin-bottom: 0px;\"}\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}