{
  "hash": "0c4f5bda4a97416481510e28e25383db",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"How to compute and visualize the Standardized Precipitation Index (SPI) for drought analysis\"\nsubtitle: \"Part 1: A step-by-step guide to calculate the SPI with the {SCI} package in R using data from Somalia at subnational level\"\nauthor: \n - name: \n    given: Juan Armando \n    family: Torres Mungu√≠a\ndate: \"2025-02-08\"\ncategories: \n - data analysis\n - drought\n - tidyverse\n - ggplot2\n - box plots\n - SCI\n - Standardized Precipitation Index (SPI)\n - Somalia\nimage: \"spi-somalia.png\"\ntitle-block-banner: false\ncitation: true\nexecute: \n  freeze: true\nformat: \n  html: \n    page-layout: article\ncomments:\n  utterances: \n    repo: jatorresmunguia/juan-torresmunguia.github.io\n---\n\n\n## Overview\nThe Standardized Precipitation Index (SPI) is a widely used drought index that provides a measure of precipitation anomalies relative to the long-term average. The SPI is calculated for different time scales (e.g., 1, 3, 6, 12 months) and can be used to monitor drought conditions, assess drought severity, and support drought early warning systems, as it provides a standardized measure of precipitation anomalies that can be compared across districts and time periods. \n\nIn this tutorial, we will walk through the process of calculating the SPI for Somalia at the subnational level using the {SCI} package in R.\n\n## About the data\nThe rainfall dataset used in this tutorial comes from the [Humanitarian Data Exchange (HDX) initiative](https://data.humdata.org/) of the United Nations Office for the Coordination of Humanitarian Affairs (OCHA) and provides monthly precipitation data for Somalia's subnational districts. It is derived from CHIRPS v2 (Climate Hazards Group InfraRed Precipitation with _in situ_ Station data), using satellite imagery combined with ground-based observations. \n\nFor each 10-day period (dekad), the dataset includes the following indicators:\n\n- `rfh`: Total rainfall (mm) over 10 days\n- `r1h`: 1-month rolling rainfall sum (mm) \n- `r3h`: 3-month rolling rainfall sum (mm)\n- `rfh_avg`: Long-term average rainfall for the dekad (mm)\n- `r1h_avg`: Long-term average for 1-month rolling rainfall (mm) \n- `r3h_avg`: Long-term average for 3-month rolling rainfall (mm) \n- `rfq`: Rainfall anomaly (%)\n- `r1q`: Rainfall anomaly (%)\n- `r3q`: 3-month rainfall anomaly (%)\n\nThe data is aggregated at the subnational level and follows administrative boundaries defined by the World Food Programme (WFP), with each unit assigned a unique code (`Pcode`).\n\n## Set-up\nBefore we begin, we need to install and load the necessary R packages. We will be using the {tidyverse} package for data wrangling, as well as the {SCI} package for calculating the SPI.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse) # For data manipulation and visualization\nlibrary(SCI) # For Standardized Precipitation Index calculations (climate analysis)\nlibrary(conflicted) # For resolving conflicts between function names in different packages\nlibrary(kableExtra) # Create HTML table\nlibrary(ggplot2) # Create plots\nlibrary(ggtext) # Use rich text elements in ggplot\nlibrary(showtext) # Add custom fonts to plots\n\nconflicts_prefer(dplyr::select) # Prefer 'select' function from dplyr package\nconflicts_prefer(dplyr::lag) # Prefer 'lag' function from dplyr package\nconflicts_prefer(dplyr::filter) # Prefer 'filter' function from dplyr package\n```\n:::\n\n\n::: {.callout-warning}\n\nImportant to use {conflicted} package to specify preferred functions to avoid naming conflicts between {tidyverse} and {SCI} packages.\n\n:::\n\n## Loading data HDX\nData can be found [here](https://data.humdata.org/dataset/som-rainfall-subnational) in file `som-rainfall-adm2-full.csv`. For Somalia, data is available from January 1981.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Read the rainfall data for Somalia`\n# You can also download the data from the HDX platform and read it locally\nrainfall_data <- read.csv(\"https://data.humdata.org/dataset/ed6e1b4b-8094-47e6-bdf7-f6d56fa7abb9/resource/331ab214-0860-44ea-a53b-0a3fac601e82/download/som-rainfall-adm2-full.csv\")\n```\n:::\n\n\n### Data wrangling\nWe preprocess the data to extract relevant information to calculate the SPI. We extract the year and month from the date column, calculate the rainfall anomaly, and group the data by year, month, and district_code. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nrainfall_data <- rainfall_data |>\n  slice(-1) |> # Remove the first row (metadata)\n  mutate(\n    year = year(date), # Extract year from the 'date' column\n    month = month(date), # Extract month from the 'date' column\n    district_code = ADM2_PCODE # Rename the 'ADM2_PCODE' column to 'district_code'\n  ) |>\n  filter(year < 2025) |> # Filter data up to 2024\n  rename(\n    rainfall_monthly_total = rfh, # Rename the column 'rfh' to 'rainfall_monthly_total'\n    rainfall_monthly_lt_average = rfh_avg # Rename the column 'rfh_avg' to 'rainfall_monthly_lt_average'\n  ) |>\n  mutate(\n    rainfall_monthly_total = as.numeric(rainfall_monthly_total), # Convert rainfall total to numeric\n    rainfall_monthly_lt_average = as.numeric(rainfall_monthly_lt_average) # Convert long-term average to numeric\n  ) |>\n  select(year, month, district_code, rainfall_monthly_total, rainfall_monthly_lt_average) # Select relevant columns\n\n# Group by year, month, and district_code, and calculate mean rainfall values by district\nrainfall_data <- rainfall_data |>\n  group_by(year, month, district_code) |>\n  summarise(\n    rainfall_monthly_total = mean(rainfall_monthly_total, na.rm = TRUE), # Calculate the mean of rainfall total\n    rainfall_monthly_lt_average = mean(rainfall_monthly_lt_average, na.rm = TRUE) # Calculate the mean of long-term average\n  ) |>\n  ungroup() |>\n  # Optionally, you can calculate rainfall anomaly as a percentage of the long-term average\n  # rainfall_anomaly = 1, indicates no anomaly\n  # < 1 indicates below average\n  # > 1 indicates above average\n  mutate(\n    rainfall_anomaly = rainfall_monthly_total / rainfall_monthly_lt_average\n  )\n```\n:::\n\n\n## We then calculate the SPI for different time scales (1, 3, 6, 12 months).\n\n::: {.cell}\n\n```{.r .cell-code}\nrainfall_data <- rainfall_data |>\n  group_by(district_code) |> # Group by district_code\n  mutate(\n    spi1 = transformSCI(\n      rainfall_monthly_total,\n      first.mon = 1, # Start month for SPI calculation\n      obj = fitSCI(rainfall_monthly_total,\n        first.mon = 1, # Start month for SPI calculation\n        time.scale = 1, # Time scale for SPI calculation\n        distr = \"gamma\", # Distribution for fitting\n        p0 = TRUE # Use initial parameter estimates\n      )\n    ),\n    spi3 = transformSCI(\n      rainfall_monthly_total,\n      first.mon = 1,\n      obj = fitSCI(rainfall_monthly_total,\n        first.mon = 1,\n        time.scale = 3,\n        distr = \"gamma\",\n        p0 = TRUE\n      )\n    ),\n    spi6 = transformSCI(\n      rainfall_monthly_total,\n      first.mon = 1,\n      obj = fitSCI(rainfall_monthly_total,\n        first.mon = 1,\n        time.scale = 6,\n        distr = \"gamma\",\n        p0 = TRUE\n      )\n    ),\n    spi12 = transformSCI(\n      rainfall_monthly_total,\n      first.mon = 1,\n      obj = fitSCI(rainfall_monthly_total,\n        first.mon = 1,\n        time.scale = 12,\n        distr = \"gamma\",\n        p0 = TRUE\n      )\n    )\n  ) |>\n  ungroup() |>\n  arrange(district_code)\n```\n:::\n\n\nThe output table looks like this: \n\n::: {.cell}\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table\" style=\"margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:right;\"> year </th>\n   <th style=\"text-align:right;\"> month </th>\n   <th style=\"text-align:left;\"> district_code </th>\n   <th style=\"text-align:right;\"> rainfall_monthly_total </th>\n   <th style=\"text-align:right;\"> rainfall_monthly_lt_average </th>\n   <th style=\"text-align:right;\"> rainfall_anomaly </th>\n   <th style=\"text-align:right;\"> spi1 </th>\n   <th style=\"text-align:right;\"> spi3 </th>\n   <th style=\"text-align:right;\"> spi6 </th>\n   <th style=\"text-align:right;\"> spi12 </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:right;\"> 1981 </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:left;\"> SO1101 </td>\n   <td style=\"text-align:right;\"> 0.9417333 </td>\n   <td style=\"text-align:right;\"> 1.744867 </td>\n   <td style=\"text-align:right;\"> 0.5397165 </td>\n   <td style=\"text-align:right;\"> -1.1043897 </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 1981 </td>\n   <td style=\"text-align:right;\"> 2 </td>\n   <td style=\"text-align:left;\"> SO1101 </td>\n   <td style=\"text-align:right;\"> 2.0194333 </td>\n   <td style=\"text-align:right;\"> 2.027633 </td>\n   <td style=\"text-align:right;\"> 0.9959559 </td>\n   <td style=\"text-align:right;\"> 0.1537179 </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 1981 </td>\n   <td style=\"text-align:right;\"> 3 </td>\n   <td style=\"text-align:left;\"> SO1101 </td>\n   <td style=\"text-align:right;\"> 32.8349667 </td>\n   <td style=\"text-align:right;\"> 9.696967 </td>\n   <td style=\"text-align:right;\"> 3.3861070 </td>\n   <td style=\"text-align:right;\"> 2.0618329 </td>\n   <td style=\"text-align:right;\"> 2.0528624 </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 1981 </td>\n   <td style=\"text-align:right;\"> 4 </td>\n   <td style=\"text-align:left;\"> SO1101 </td>\n   <td style=\"text-align:right;\"> 18.3139000 </td>\n   <td style=\"text-align:right;\"> 24.722233 </td>\n   <td style=\"text-align:right;\"> 0.7407866 </td>\n   <td style=\"text-align:right;\"> -0.3498790 </td>\n   <td style=\"text-align:right;\"> 0.9691425 </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 1981 </td>\n   <td style=\"text-align:right;\"> 5 </td>\n   <td style=\"text-align:left;\"> SO1101 </td>\n   <td style=\"text-align:right;\"> 6.7928667 </td>\n   <td style=\"text-align:right;\"> 17.754700 </td>\n   <td style=\"text-align:right;\"> 0.3825954 </td>\n   <td style=\"text-align:right;\"> -1.1682135 </td>\n   <td style=\"text-align:right;\"> 0.3442811 </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 1981 </td>\n   <td style=\"text-align:right;\"> 6 </td>\n   <td style=\"text-align:left;\"> SO1101 </td>\n   <td style=\"text-align:right;\"> 2.7443667 </td>\n   <td style=\"text-align:right;\"> 4.763233 </td>\n   <td style=\"text-align:right;\"> 0.5761563 </td>\n   <td style=\"text-align:right;\"> -1.1812491 </td>\n   <td style=\"text-align:right;\"> -1.5029868 </td>\n   <td style=\"text-align:right;\"> 0.1547485 </td>\n   <td style=\"text-align:right;\"> NA </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 1981 </td>\n   <td style=\"text-align:right;\"> 7 </td>\n   <td style=\"text-align:left;\"> SO1101 </td>\n   <td style=\"text-align:right;\"> 17.3592333 </td>\n   <td style=\"text-align:right;\"> 14.047767 </td>\n   <td style=\"text-align:right;\"> 1.2357290 </td>\n   <td style=\"text-align:right;\"> 0.7686622 </td>\n   <td style=\"text-align:right;\"> -0.9047071 </td>\n   <td style=\"text-align:right;\"> 0.3837349 </td>\n   <td style=\"text-align:right;\"> NA </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 1981 </td>\n   <td style=\"text-align:right;\"> 8 </td>\n   <td style=\"text-align:left;\"> SO1101 </td>\n   <td style=\"text-align:right;\"> 34.8381667 </td>\n   <td style=\"text-align:right;\"> 26.758133 </td>\n   <td style=\"text-align:right;\"> 1.3019655 </td>\n   <td style=\"text-align:right;\"> 0.8281642 </td>\n   <td style=\"text-align:right;\"> 0.7648521 </td>\n   <td style=\"text-align:right;\"> 0.7381726 </td>\n   <td style=\"text-align:right;\"> NA </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 1981 </td>\n   <td style=\"text-align:right;\"> 9 </td>\n   <td style=\"text-align:left;\"> SO1101 </td>\n   <td style=\"text-align:right;\"> 29.1683000 </td>\n   <td style=\"text-align:right;\"> 19.003000 </td>\n   <td style=\"text-align:right;\"> 1.5349313 </td>\n   <td style=\"text-align:right;\"> 1.2521209 </td>\n   <td style=\"text-align:right;\"> 1.2301335 </td>\n   <td style=\"text-align:right;\"> 0.0193033 </td>\n   <td style=\"text-align:right;\"> NA </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 1981 </td>\n   <td style=\"text-align:right;\"> 10 </td>\n   <td style=\"text-align:left;\"> SO1101 </td>\n   <td style=\"text-align:right;\"> 4.1974333 </td>\n   <td style=\"text-align:right;\"> 8.226200 </td>\n   <td style=\"text-align:right;\"> 0.5102518 </td>\n   <td style=\"text-align:right;\"> -0.3816687 </td>\n   <td style=\"text-align:right;\"> 0.7653220 </td>\n   <td style=\"text-align:right;\"> 0.1559546 </td>\n   <td style=\"text-align:right;\"> NA </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n## Interpretation\nDrought events are indicated by negative SPI values, with more negative values indicating more severe drought conditions. Conversely, positive SPI values indicate wetter-than-average conditions. For demonstrating purposes, let's visualize the SPI values for Laasqoray district in Sanaag region. One efficient way to visualize SPI values is by using a box plot with SPI categories.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Custom theme for the chart\ntheme_boxplot_chart <- function() {\n  theme_minimal(\n    base_family = \"Roboto Condensed\" # Base theme with custom font\n  ) +\n    # Custom theme settings\n    theme(\n      # Axis settings\n      axis.title = element_text(\n        color = \"grey10\",\n        face = \"bold\",\n        size = 14\n      ),\n      axis.text = element_text(\n        color = \"grey10\",\n        face = \"bold\",\n        size = 12\n      ),\n\n      # Title settings\n      plot.title.position = \"plot\", # Position of the title\n      plot.title = element_textbox(\n        color = \"black\",\n        face = \"bold\",\n        size = 24,\n        margin = margin(5, 0, 5, 0), # Top, right, bottom, left\n        width = unit(1, \"npc\") # Width of the title, npc == 1 corresponds to the full width of the plot\n      ),\n\n      # Legend settings\n      legend.position = \"top\",\n      legend.title = element_blank(),\n      legend.key.height = unit(0.5, \"cm\"), # Height of the legend key\n      legend.key.width = unit(0.5, \"cm\"), # Width of the legend key\n      legend.spacing.x = unit(0.2, \"cm\"),\n      legend.key.spacing = unit(0.5, \"cm\"), # Spacing between legend keys\n      legend.text = element_text(\n        margin = margin(5, 0, 5, 0),\n        face = \"bold\",\n        color = \"grey10\",\n        size = 10\n      ),\n      legend.direction = \"horizontal\",\n      legend.byrow = FALSE,\n\n      # Caption settings\n      plot.caption = element_textbox(\n        color = \"grey70\",\n        face = \"italic\",\n        size = 12,\n        margin = margin(10, 0, 5, 0),\n        width = unit(1, \"npc\")\n      ),\n      plot.background = element_rect(\n        color = \"white\",\n        fill = \"white\"\n      ),\n      plot.margin = margin(20, 40, 20, 40)\n    )\n}\n\n# Title, subtitle, and caption for the boxplot chart\ntitle_chart <- \"1-month Standardized Precipitation Index (SPI-1) in Laasqoray, Somalia for the period 1981-2024\"\ncaption_chart <- \"Data: Somalia: Own estimations using rainfall Indicators at Subnational Level (HDX) | Graphic: Juan Torres Mungu√≠a\"\n\n# \nspi_colors <- data.frame(\n  ymin = c(-5, -2, -1.5, -1, 0, 1, 1.5, 2),\n  ymax = c(-2, -1.5, -1, 0, 1, 1.5, 2, 5),\n  label = factor(\n    c(\n      \"Extremely dry\", \"Severely dry\", \"Moderately dry\", \"Near normal\",\n      \"Near normal\", \"Moderately wet\", \"Severely wet\", \"Extremely wet\"\n    ),\n    levels = c(\n      \"Extremely dry\", \"Severely dry\", \"Moderately dry\", \"Near normal\",\n      \"Moderately wet\", \"Severely wet\", \"Extremely wet\"\n    )\n  ), \n  fill = c(\n    \"#F76D5E\", \"#FFAD72\", \"#FFE099\", \"#99FF99\",\n    \"#99FF99\", \"#99EAFF\", \"#75D3FF\", \"#3D87FF\"\n  )\n)\n\nrainfall_data |>\n  filter(district_code == \"SO1503\") |>\n  mutate(month = factor(month, levels = 1:12, labels = month.name)) |> # Convert month to factor\n  ggplot(aes(x = month, y = spi1)) +\n\n  # Add box plot with SPI categories\n  geom_rect(\n    data = spi_colors, aes(ymin = ymin, ymax = ymax, xmin = -Inf, xmax = Inf, fill = label),\n    alpha = 0.2, inherit.aes = FALSE\n  ) +\n  geom_boxplot(size = 1, outlier.size = 2, outlier.shape = 16) +\n  scale_fill_manual(values = setNames(spi_colors$fill, spi_colors$label)) +\n  labs(\n    title = title_chart,\n    caption = caption_chart,\n    x = \"\",\n    y = \"SPI-1\",\n    fill = \"\"\n  ) +\n  guides(fill = guide_legend(nrow = 1)) + # Number of rows in the legend\n  theme_boxplot_chart()\n```\n\n```{.r .cell-code}\nshowtext_opts(dpi = 320) # Set the resolution of the image 320 dpi is for high-quality images (\"retina\")\nggsave(\n  \"spi-somalia.png\",\n  dpi = 320,\n  width = 12,\n  height = 9,\n  units = \"in\"\n)\nshowtext_auto(FALSE) # Turn off the showtext functionality\n```\n:::\n\n\n![](spi-somalia.png){width=100% style=\"margin-top: 0px; margin-bottom: 0px;\"}\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../../../site_libs/kePrint-0.0.1/kePrint.js\"></script>\n<link href=\"../../../site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}